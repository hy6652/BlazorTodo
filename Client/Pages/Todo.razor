@page "/todo"
@using BlazorTodo.Shared
@inject HttpClient http

<PageTitle>Todo</PageTitle>

<h3>Todo (@todos.Count(todo => todo.IsDone))</h3>

@if (todos != null)
{
    <ul>
        @foreach (var todo in todos)
        {
            <li>
                <input type="checkbox" @bind="todo.IsDone" />
                <input @bind="todo.Title" />
                <button @onclick="() => DeleteTodo(todo)">Delete</button>
                <button @onclick="() => UpdateTodo(todo)">Edit</button>
            </li>
        }
    </ul>
}

<input placeholder="Something todo" @bind="@newTodo.Title" />
<button @onclick="CreateTodo">Add todo</button>

@code {
    private TodoItem newTodo = new();
    private TodoItem[]? todos;
    TodoItem todo = new();

    private void AddTodo()
    {
        var httpResult = await http.PostAsJsonAsync<TodoItem>("api/Todo/CreateTodo", newTodo);

        if (httpResult.IsSuccessStatusCode)
        {
            Console.WriteLine("SUCCESS");
            newTodo = new();
        }
        else
        {
            Console.WriteLine("FAIL");    
        }

        await GetAllTodo();
    }

    protected override async Task OnInitializedAsync()
    {
        await GetAllTodo();
    }

    public async Task UpdateTodo(TodoItem todo)
    {
        var updateTodo = await http.PatchAsJsonAsync<TodoItem>("api/Todo/UpdateTodo", todo);

        if (updateTodo.IsSuccessStatusCode)
        {
            Console.WriteLine("SUCCESS");
        }
        else
        {
            Console.WriteLine("FAIL");
        }
        
        await GetAllTodo();
    }

    public async Task DeleteTodo(TodoItem todo)
    {
        var deleteTodo = await http.PostAsJsonAsync<TodoItem>("api/Todo/DeleteTodo", todo);

        if (deleteTodo.IsSuccessStatusCode)
        {
            Console.WriteLine("SUCCESS");
        }
        else
        {
            Console.WriteLine("FAIL");
        }

        await GetAllTodo();
    }

    public async Task GetAllTodo()
    {
        todos = await http.GetFromJsonAsync<TodoItem[]>("api/Todo/GetAllTodo");
    }
}
